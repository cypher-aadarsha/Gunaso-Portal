<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Gunaso Portal</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <!-- Toastify -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Timeline Styles */
        .timeline-item { position: relative; padding-left: 2rem; padding-bottom: 2rem; border-left: 2px solid #e5e7eb; }
        .timeline-item:last-child { border-left: 2px solid transparent; }
        .timeline-dot { position: absolute; left: -9px; top: 0; width: 16px; height: 16px; border-radius: 50%; border: 2px solid #fff; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <!-- Navigation -->
    <nav class="bg-white border-b border-gray-200 sticky top-0 z-40 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <!-- Branding -->
                <div class="flex items-center">
                    <img src="images/Govt Logo.jpeg" alt="Logo" class="h-8 w-auto mr-3">
                    <span class="text-xl font-bold text-gray-900">Gunaso <span class="text-blue-600">Admin</span></span>
                    <span id="ministry-badge" class="ml-4 px-3 py-1 rounded-full text-xs font-medium bg-blue-50 text-blue-700 border border-blue-100 hidden"></span>
                </div>

                <!-- Right Side -->
                <div class="flex items-center space-x-6">
                    <!-- Bulk Create Button (Super Admin Only) -->
                    <button id="btn-bulk-create" onclick="openBulkModal()" class="hidden items-center text-sm font-medium text-white bg-green-600 hover:bg-green-700 transition px-3 py-2 rounded-md shadow-sm">
                        <i class="fa-solid fa-file-excel mr-2"></i> Bulk Create
                    </button>

                    <!-- Download Analytics Report -->
                    <button onclick="downloadReport()" class="hidden md:flex items-center text-sm font-medium text-gray-600 hover:text-blue-600 transition bg-gray-50 hover:bg-blue-50 px-3 py-2 rounded-md border border-gray-200 hover:border-blue-200">
                        <i class="fa-solid fa-chart-pie mr-2"></i> Analytics
                    </button>

                    <!-- Notification Bell -->
                    <div class="relative cursor-pointer" id="notification-container">
                        <div onclick="toggleNotifications()" class="relative p-2 hover:bg-gray-100 rounded-full transition">
                            <i class="fa-regular fa-bell text-gray-600 text-xl"></i>
                            <span id="notification-badge" class="absolute top-0 right-0 flex h-5 w-5 items-center justify-center rounded-full bg-red-500 text-[10px] font-bold text-white opacity-0 transition-opacity duration-300 shadow-sm border border-white">0</span>
                        </div>
                        <div id="notification-dropdown" class="absolute right-0 top-12 w-80 bg-white border border-gray-100 shadow-xl rounded-xl hidden z-50 overflow-hidden ring-1 ring-black ring-opacity-5">
                            <div class="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                                <h3 class="text-sm font-bold text-gray-900">Notifications</h3>
                                <button onclick="markAllAsRead()" class="text-xs text-blue-600 hover:text-blue-800 font-medium hover:underline">Mark all as read</button>
                            </div>
                            <div id="notification-list" class="max-h-80 overflow-y-auto"></div>
                        </div>
                    </div>

                    <button onclick="handleLogout()" class="text-sm text-red-600 hover:bg-red-50 px-3 py-2 rounded-md transition-colors font-medium">
                        <i class="fa-solid fa-right-from-bracket mr-2"></i> Logout
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
        
        <!-- Welcome Section -->
        <div class="mb-8 flex flex-col sm:flex-row justify-between items-start sm:items-center">
            <div>
                <h1 class="text-2xl font-bold text-gray-900" id="welcome-msg">Welcome, Admin</h1>
                <p class="text-gray-500 mt-1 text-sm">Here is what's happening in your jurisdiction today.</p>
            </div>
            <div class="mt-4 sm:mt-0 text-sm text-gray-500">
                <i class="fa-regular fa-calendar mr-2"></i> <span id="current-date"></span>
            </div>
        </div>

        <!-- ANALYTICS SECTION -->
        <div id="report-section" class="bg-gray-50 p-2 rounded-xl">
            <div class="flex justify-between items-center mb-4 px-2">
                <h2 class="text-lg font-bold text-gray-700 uppercase tracking-wide">Weekly Status Report</h2>
                <span class="text-xs text-gray-400 bg-white px-2 py-1 rounded border">Generated by Gunaso Portal</span>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-8">
                <!-- Stats Cards -->
                <div class="lg:col-span-3 grid grid-cols-1 sm:grid-cols-3 gap-6">
                    <!-- Card 1 -->
                    <div class="bg-white p-6 rounded-xl border border-gray-100 shadow-sm flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-500">Total Grievances</p>
                            <p class="text-3xl font-bold text-gray-900 mt-2" id="stat-total">0</p>
                        </div>
                        <div class="h-12 w-12 bg-blue-50 rounded-full flex items-center justify-center text-blue-600">
                            <i class="fa-solid fa-folder-open text-xl"></i>
                        </div>
                    </div>
                    <!-- Card 2 -->
                    <div class="bg-white p-6 rounded-xl border border-gray-100 shadow-sm flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-500">Resolved</p>
                            <p class="text-3xl font-bold text-green-600 mt-2" id="stat-resolved">0</p>
                        </div>
                        <div class="h-12 w-12 bg-green-50 rounded-full flex items-center justify-center text-green-600">
                            <i class="fa-solid fa-check text-xl"></i>
                        </div>
                    </div>
                    <!-- Card 3 -->
                    <div class="bg-white p-6 rounded-xl border border-gray-100 shadow-sm flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-500">Pending Action</p>
                            <p class="text-3xl font-bold text-orange-600 mt-2" id="stat-pending">0</p>
                        </div>
                        <div class="h-12 w-12 bg-orange-50 rounded-full flex items-center justify-center text-orange-600">
                            <i class="fa-solid fa-clock text-xl"></i>
                        </div>
                    </div>
                </div>

                <!-- Chart -->
                <div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex flex-col items-center justify-center lg:col-span-1">
                    <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wide mb-2 w-full text-left">Status Distribution</h3>
                    <div class="h-32 w-full relative">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- PMO Stats Filters -->
        <div id="pmo-controls" class="hidden mb-6 bg-white p-4 rounded-lg shadow-sm border border-purple-100">
            <h3 class="text-xs font-bold text-purple-700 mb-3 uppercase tracking-wider flex items-center">
                <i class="fa-solid fa-sliders mr-2"></i> PMO Global Filters
            </h3>
            <div class="flex flex-col md:flex-row gap-4">
                <div class="flex-1">
                    <select id="ministry-filter" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 sm:text-sm p-2 border">
                        <option value="">View All Ministries</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button onclick="loadDashboardData()" class="px-4 py-2 bg-purple-600 text-white rounded-md text-sm hover:bg-purple-700 transition font-medium w-full md:w-auto">Apply Filter</button>
                </div>
            </div>
        </div>

        <!-- Complaints Table -->
        <div class="bg-white shadow-sm rounded-xl border border-gray-200 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200 bg-gray-50 flex justify-between items-center">
                <h3 class="text-lg font-bold text-gray-800">Recent Grievances</h3>
                <button onclick="loadDashboardData()" class="text-sm text-blue-600 hover:text-blue-800 font-medium transition"><i class="fa-solid fa-rotate mr-1"></i> Refresh</button>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">ID</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Subject</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">AI Category</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Priority</th>
                            <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="complaints-table-body" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="6" class="px-6 py-12 text-center text-gray-500">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- DETAILS MODAL (Updated) -->
    <div id="details-modal" class="fixed inset-0 z-50 hidden" aria-modal="true">
        <div class="absolute inset-0 bg-gray-900 bg-opacity-50 backdrop-blur-sm transition-opacity" onclick="closeDetailsModal()"></div>
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl z-10 overflow-hidden flex flex-col max-h-[90vh]">
                
                <!-- Modal Header -->
                <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                    <div>
                        <h3 class="text-lg font-bold text-gray-900" id="detail-title">...</h3>
                        <p class="text-xs text-gray-500 font-mono mt-0.5" id="detail-id">ID: ...</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <!-- NEW: Print Button -->
                        <button onclick="printComplaintDetails()" class="text-gray-600 hover:text-blue-600 bg-white border border-gray-200 hover:bg-blue-50 focus:ring-4 focus:outline-none focus:ring-blue-100 font-medium rounded-lg text-sm px-3 py-2 text-center inline-flex items-center transition">
                            <i class="fa-solid fa-print mr-2"></i> Print Lifecycle
                        </button>
                        <button onclick="closeDetailsModal()" class="text-gray-400 hover:text-gray-600 transition p-2">
                            <i class="fa-solid fa-xmark text-xl"></i>
                        </button>
                    </div>
                </div>

                <div class="p-6 overflow-y-auto flex-1">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Left Col: Details -->
                        <div class="lg:col-span-2 space-y-6">
                            
                            <!-- Description Box -->
                            <div>
                                <h4 class="text-sm font-bold text-gray-900 mb-2">Description</h4>
                                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 text-sm text-gray-700 leading-relaxed whitespace-pre-wrap" id="detail-desc">...</div>
                            </div>

                            <!-- Attachments -->
                            <div id="attachment-section">
                                <h4 class="text-sm font-bold text-gray-900 mb-2">Supporting Documents</h4>
                                <div id="detail-attachment-container"></div>
                            </div>

                            <!-- NEW: Professional Timeline for Responses -->
                            <div>
                                <h4 class="text-sm font-bold text-gray-900 mb-3 flex items-center">
                                    <i class="fa-solid fa-clock-rotate-left mr-2 text-blue-600"></i> Complaint Lifecycle & Official Remarks
                                </h4>
                                <div id="detail-timeline" class="ml-2">
                                    <!-- Timeline injected via JS -->
                                </div>
                            </div>
                        </div>

                        <!-- Right Col: Metadata -->
                        <div class="space-y-4">
                            <!-- AI Analysis Card -->
                            <div class="bg-purple-50 p-4 rounded-lg border border-purple-100">
                                <h4 class="text-xs font-bold text-purple-700 uppercase mb-3 flex items-center"><i class="fa-solid fa-robot mr-2"></i> AI Analysis</h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between border-b border-purple-100 pb-1">
                                        <span class="text-gray-600">Category:</span>
                                        <span class="font-medium text-gray-900 text-right" id="detail-category">...</span>
                                    </div>
                                    <div class="flex justify-between pt-1">
                                        <span class="text-gray-600">Priority:</span>
                                        <span class="font-bold" id="detail-priority">...</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Complainant Card -->
                            <div class="bg-gray-50 p-4 rounded-lg border border-gray-100">
                                <h4 class="text-xs font-bold text-gray-700 uppercase mb-3 flex items-center"><i class="fa-solid fa-user mr-2"></i> Complainant</h4>
                                <div class="space-y-2 text-sm">
                                    <p><span class="block text-xs text-gray-500">Name</span> <span class="font-medium text-gray-900" id="detail-user">...</span></p>
                                    <p><span class="block text-xs text-gray-500">Email</span> <span class="font-medium text-gray-900" id="detail-email">...</span></p>
                                    <p><span class="block text-xs text-gray-500">Phone</span> <span class="font-medium text-gray-900" id="detail-phone">N/A</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="px-6 py-4 bg-gray-50 border-t border-gray-100 flex justify-end space-x-3">
                    <button onclick="closeDetailsModal()" class="px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 transition">Close</button>
                    <button id="btn-open-update" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition shadow-sm">
                        <i class="fa-solid fa-pen-to-square mr-2"></i> Update Status
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Status Modal (Unchanged structure) -->
    <div id="status-modal" class="fixed inset-0 z-[60] hidden" aria-modal="true"><div class="absolute inset-0 bg-gray-900 bg-opacity-60 backdrop-blur-sm" onclick="closeStatusModal()"></div><div class="flex items-center justify-center min-h-screen p-4"><div class="bg-white rounded-lg shadow-xl w-full max-w-md z-10 p-6 relative"><h3 class="text-lg font-bold text-gray-900 mb-4">Update Resolution Status</h3><div class="space-y-4"><div><label class="block text-sm font-medium text-gray-700 mb-1">New Status</label><select id="update-status-select" class="block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"><option value="PENDING">Pending</option><option value="IN_PROGRESS">In Progress</option><option value="RESOLVED">Resolved</option><option value="REJECTED">Rejected</option></select></div><div><label class="block text-sm font-medium text-gray-700 mb-1">Official Remarks (Visible to Citizen)</label><textarea id="update-remarks" rows="3" class="block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Remarks..."></textarea></div></div><div class="mt-6 flex justify-end space-x-3"><button onclick="closeStatusModal()" class="px-4 py-2 bg-white border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">Cancel</button><button onclick="submitStatusUpdate()" class="px-4 py-2 bg-blue-600 text-white rounded-md text-sm font-medium hover:bg-blue-700 shadow-sm">Confirm Update</button></div></div></div></div>

    <!-- Bulk Upload Modal (Unchanged) -->
    <div id="bulk-modal" class="fixed inset-0 z-50 hidden" aria-modal="true"><div class="absolute inset-0 bg-gray-900 bg-opacity-60 backdrop-blur-sm" onclick="closeBulkModal()"></div><div class="flex items-center justify-center min-h-screen p-4"><div class="bg-white rounded-xl shadow-2xl w-full max-w-lg z-10 p-6 relative"><div class="flex justify-between items-center mb-4"><h3 class="text-lg font-bold text-gray-900">Bulk Create Admin Accounts</h3><button onclick="closeBulkModal()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark"></i></button></div><p class="text-sm text-gray-500 mb-4">Upload an Excel file (.xlsx) to create multiple admin accounts at once.<br>Format: <strong>Username, Email, Password, First Name, Last Name, Phone, Ministry, Department</strong>.</p><div class="space-y-4"><div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:bg-gray-50 transition cursor-pointer" onclick="document.getElementById('bulk-file').click()"><i class="fa-solid fa-file-excel text-green-600 text-3xl mb-2"></i><p class="text-sm font-medium text-gray-700" id="bulk-file-label">Click to select Excel file</p><input type="file" id="bulk-file" accept=".xlsx" class="hidden" onchange="updateFileLabel(this)"></div></div><div id="bulk-result" class="mt-4 hidden p-3 rounded-md text-sm"></div><div class="mt-6 flex justify-end space-x-3"><button onclick="closeBulkModal()" class="px-4 py-2 bg-white border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">Cancel</button><button onclick="submitBulkUpload()" id="btn-upload-bulk" class="px-4 py-2 bg-green-600 text-white rounded-md text-sm font-medium hover:bg-green-700 shadow-sm"><i class="fa-solid fa-upload mr-2"></i> Upload & Create</button></div></div></div></div>

    <script>
        const API_URL = 'http://127.0.0.1:8000/api';
        let currentRole = 'ADMIN'; let selectedComplaintId = null; let complaintsData = []; let statusChart = null;
        let currentComplaint = null; // Store currently viewed complaint for printing
        const token = localStorage.getItem('accessToken');
        if (!token) window.location.href = 'login.html';

        document.getElementById('current-date').textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

        document.addEventListener('DOMContentLoaded', async () => {
            await loadProfile();
            await loadDashboardData();
            document.addEventListener('click', (e) => { if (!document.getElementById('notification-container').contains(e.target)) document.getElementById('notification-dropdown').classList.add('hidden'); });
        });

        // --- PRINT FUNCTIONALITY (PROFESSIONAL LIFECYCLE REPORT) ---
        function printComplaintDetails() {
            if (!currentComplaint) return;
            const c = currentComplaint;
            const u = c.created_by || {};
            const updates = c.updates || [];
            const currentDate = new Date().toLocaleDateString();

            // Construct Timeline HTML for Print
            let timelineHtml = '';
            // Initial Submission
            timelineHtml += `
                <div class="event">
                    <div class="date">${new Date(c.created_at).toLocaleString()}</div>
                    <div class="marker start"></div>
                    <div class="content">
                        <strong>Complaint Filed</strong><br>
                        Status set to PENDING.
                    </div>
                </div>
            `;
            
            // Updates
            updates.forEach(up => {
                const dateStr = new Date(up.created_at).toLocaleString();
                timelineHtml += `
                    <div class="event">
                        <div class="date">${dateStr}</div>
                        <div class="marker"></div>
                        <div class="content">
                            <strong>${up.update_text.includes('[Admin]') ? 'Official Response' : 'Update'}</strong><br>
                            ${up.update_text.replace('[Admin]:', '').replace('[Admin Status Update]:', '')}
                            <br><span style="font-size:10px; color:#666;">By: ${up.user || 'Administration'}</span>
                        </div>
                    </div>
                `;
            });

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Grievance Report - ${c.tracking_id}</title>
                    <style>
                        body { font-family: 'Times New Roman', serif; padding: 40px; color: #333; line-height: 1.5; }
                        .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 20px; margin-bottom: 30px; }
                        .header img { height: 80px; margin-bottom: 10px; }
                        .header h1 { margin: 5px 0; font-size: 24px; text-transform: uppercase; }
                        .header h2 { margin: 5px 0; font-size: 16px; font-weight: normal; }
                        
                        .section { margin-bottom: 25px; }
                        .section-title { font-size: 14px; font-weight: bold; text-transform: uppercase; border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-bottom: 15px; color: #444; }
                        
                        .grid { display: table; width: 100%; }
                        .row { display: table-row; }
                        .cell { display: table-cell; padding: 5px 10px; width: 50%; vertical-align: top; }
                        .label { font-weight: bold; color: #555; width: 120px; display: inline-block; }
                        
                        .description-box { background: #f9f9f9; padding: 15px; border: 1px solid #eee; text-align: justify; font-family: sans-serif; font-size: 13px; }
                        
                        /* Timeline for Print */
                        .timeline { border-left: 2px solid #ccc; margin-left: 10px; padding-left: 20px; margin-top: 10px; }
                        .event { margin-bottom: 20px; position: relative; }
                        .marker { width: 10px; height: 10px; background: #333; border-radius: 50%; position: absolute; left: -26px; top: 5px; }
                        .marker.start { background: #000; }
                        .date { font-size: 11px; color: #666; margin-bottom: 2px; }
                        .content { font-size: 13px; background: #fff; }
                        
                        .footer { margin-top: 50px; border-top: 1px solid #ccc; padding-top: 10px; font-size: 10px; text-align: center; color: #777; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <img src="images/Govt Logo.jpeg" alt="Logo">
                        <h1>Government of Nepal</h1>
                        <h2>Ministry of Education, Science and Technology</h2>
                        <h3>Grievance Lifecycle Report</h3>
                    </div>

                    <div class="section">
                        <div class="section-title">1. Grievance Information</div>
                        <div class="grid">
                            <div class="row">
                                <div class="cell"><span class="label">Tracking ID:</span> ${c.tracking_id}</div>
                                <div class="cell"><span class="label">Current Status:</span> <strong>${c.status}</strong></div>
                            </div>
                            <div class="row">
                                <div class="cell"><span class="label">Submission Date:</span> ${new Date(c.created_at).toLocaleDateString()}</div>
                                <div class="cell"><span class="label">Category:</span> ${c.ai_suggested_category || 'N/A'}</div>
                            </div>
                            <div class="row">
                                <div class="cell"><span class="label">Subject:</span> ${c.title}</div>
                                <div class="cell"><span class="label">Priority:</span> ${c.ai_suggested_priority || 'LOW'}</div>
                            </div>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">2. Complainant Details</div>
                        <div class="grid">
                            <div class="row">
                                <div class="cell"><span class="label">Name:</span> ${u.first_name || ''} ${u.last_name || u.username}</div>
                                <div class="cell"><span class="label">Email:</span> ${u.email || 'N/A'}</div>
                            </div>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">3. Detailed Description</div>
                        <div class="description-box">
                            ${c.description.replace(/\n/g, '<br>')}
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">4. Lifecycle & Official Response History</div>
                        <div class="timeline">
                            ${timelineHtml}
                        </div>
                    </div>

                    <div class="footer">
                        Generated by Gunaso Portal System on ${currentDate}.<br>
                        This is a computer-generated document.
                    </div>
                    <script>window.print();<\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        // --- CORE FUNCTIONS ---

        function openDetailsModal(id) {
            const c = complaintsData.find(x => x.tracking_id === id); if(!c) return;
            currentComplaint = c; // Set for printing
            
            document.getElementById('detail-title').textContent = c.title; 
            document.getElementById('detail-id').textContent = `ID: ${c.tracking_id}`; 
            document.getElementById('detail-desc').textContent = c.description; 
            document.getElementById('detail-category').textContent = c.ai_suggested_category || 'Uncategorized';
            document.getElementById('detail-priority').textContent = c.ai_suggested_priority || 'LOW'; 
            document.getElementById('detail-priority').className = c.ai_suggested_priority === 'HIGH' ? 'text-red-600 font-bold' : 'font-bold text-gray-900';
            const u = c.created_by || {}; 
            document.getElementById('detail-user').textContent = `${u.first_name||''} ${u.last_name||u.username||'Unknown'}`; 
            document.getElementById('detail-email').textContent = u.email||'N/A';
            
            // Attachment
            const cont = document.getElementById('detail-attachment-container');
            if (c.attachment) {
                const ext = c.attachment.split('.').pop().toLowerCase();
                let icon='fa-file', col='text-gray-500', prev='';
                if(['jpg','jpeg','png'].includes(ext)) { icon='fa-image'; col='text-blue-500'; prev=`<img src="${c.attachment}" class="h-16 w-16 object-cover rounded border ml-3 cursor-pointer" onclick="window.open('${c.attachment}')">`; }
                else if(ext==='pdf') { icon='fa-file-pdf'; col='text-red-500'; } else if(['doc','docx'].includes(ext)) { icon='fa-file-word'; col='text-blue-700'; }
                cont.innerHTML = `<div class="flex items-center p-3 bg-gray-50 border rounded-lg hover:bg-gray-100 transition"><div class="mr-3 ${col} text-3xl"><i class="fa-solid ${icon}"></i></div><div class="flex-1 overflow-hidden"><p class="text-sm font-medium text-gray-900 truncate">Document.${ext}</p><a href="${c.attachment}" target="_blank" class="text-xs text-blue-600 hover:underline">Download</a></div>${prev}</div>`;
                document.getElementById('attachment-section').classList.remove('hidden');
            } else document.getElementById('attachment-section').classList.add('hidden');

            // --- BUILD PROFESSIONAL TIMELINE ---
            const timeline = document.getElementById('detail-timeline');
            timeline.innerHTML = '';
            
            // 1. Start Node
            timeline.innerHTML += `
                <div class="timeline-item">
                    <div class="timeline-dot bg-blue-100 border-blue-500"></div>
                    <p class="text-xs text-gray-500 mb-1">${new Date(c.created_at).toLocaleString()}</p>
                    <p class="text-sm font-semibold text-gray-900">Complaint Filed</p>
                    <p class="text-xs text-gray-600">Status initialized to Pending.</p>
                </div>
            `;

            // 2. Updates
            if (c.updates && c.updates.length > 0) {
                // Reverse to show oldest first or keep newest first? Usually timeline is oldest top.
                // API returns newest first. Let's reverse for timeline view.
                [...c.updates].reverse().forEach(up => {
                    const isStatusChange = up.update_text.toLowerCase().includes('status');
                    const isAdmin = up.update_text.includes('[Admin]');
                    let dotColor = isStatusChange ? 'border-orange-400 bg-orange-100' : 'border-gray-300 bg-gray-100';
                    let contentClass = 'text-gray-700';
                    let boxClass = '';

                    // Styling for Official Admin Remarks
                    if (isAdmin) {
                        dotColor = 'border-blue-600 bg-blue-100';
                        boxClass = 'bg-blue-50 p-3 rounded-md border border-blue-100 mt-2 shadow-sm';
                    }

                    timeline.innerHTML += `
                        <div class="timeline-item">
                            <div class="timeline-dot ${dotColor}"></div>
                            <p class="text-xs text-gray-500 mb-1">${new Date(up.created_at).toLocaleString()}</p>
                            <div class="${boxClass}">
                                ${isAdmin ? '<p class="text-xs font-bold text-blue-700 uppercase mb-1">Official Response</p>' : ''}
                                <p class="text-sm ${contentClass}">${up.update_text.replace('[Admin]:', '')}</p>
                                <p class="text-[10px] text-gray-400 mt-1 text-right">By: ${up.user}</p>
                            </div>
                        </div>
                    `;
                });
            }

            document.getElementById('btn-open-update').onclick = () => { closeDetailsModal(); openStatusModal(c.tracking_id, c.status); };
            document.getElementById('details-modal').classList.remove('hidden'); document.getElementById('notification-dropdown').classList.add('hidden');
        }

        // --- Standard Boilerplate (Unchanged) ---
        function closeDetailsModal() { document.getElementById('details-modal').classList.add('hidden'); currentComplaint = null; }
        function openStatusModal(id, status) { selectedComplaintId = id; document.getElementById('update-status-select').value = status; document.getElementById('status-modal').classList.remove('hidden'); }
        function closeStatusModal() { document.getElementById('status-modal').classList.add('hidden'); selectedComplaintId = null; }
        
        async function submitStatusUpdate() {
            if (!selectedComplaintId) return;
            const status = document.getElementById('update-status-select').value; const rem = document.getElementById('update-remarks').value;
            try {
                await fetch(`${API_URL}/complaints/${selectedComplaintId}/`, { method: 'PATCH', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ status }) });
                if (rem.trim()) await fetch(`${API_URL}/complaint-updates/`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ complaint_id: selectedComplaintId, update_text: `[Admin]: ${rem}` }) });
                Toastify({ text: "Updated successfully", style: { background: "#10b981" } }).showToast(); closeStatusModal(); loadDashboardData();
            } catch (e) { Toastify({ text: "Update failed", style: { background: "#ef4444" } }).showToast(); }
        }

        // Bulk Upload, Report Download, Profile Loaders (Same as previous)
        function openBulkModal() { document.getElementById('bulk-modal').classList.remove('hidden'); }
        function closeBulkModal() { document.getElementById('bulk-modal').classList.add('hidden'); document.getElementById('bulk-file').value = ''; document.getElementById('bulk-file-label').innerText = 'Click to select Excel file'; document.getElementById('bulk-result').classList.add('hidden'); }
        function updateFileLabel(input) { if(input.files && input.files[0]) document.getElementById('bulk-file-label').innerText = input.files[0].name; }
        async function submitBulkUpload() { const input = document.getElementById('bulk-file'); const resultDiv = document.getElementById('bulk-result'); const btn = document.getElementById('btn-upload-bulk'); if (!input.files || !input.files[0]) { Toastify({ text: "Please select a file first", style: { background: "#ef4444" } }).showToast(); return; } const formData = new FormData(); formData.append('file', input.files[0]); btn.disabled = true; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> Processing...'; resultDiv.classList.add('hidden'); try { const res = await fetch(`${API_URL}/bulk-admin-create/`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` }, body: formData }); const data = await res.json(); resultDiv.classList.remove('hidden'); if (res.ok) { resultDiv.className = "mt-4 p-3 rounded-md text-sm bg-green-50 text-green-800 border border-green-200"; resultDiv.innerHTML = `<strong>Success!</strong> ${data.message}`; if(data.errors && data.errors.length > 0) { resultDiv.innerHTML += `<br><br><strong>Warnings:</strong><ul class="list-disc pl-5 mt-1">${data.errors.map(e => `<li>${e}</li>`).join('')}</ul>`; } setTimeout(() => { closeBulkModal(); loadDashboardData(); }, 3000); } else { resultDiv.className = "mt-4 p-3 rounded-md text-sm bg-red-50 text-red-800 border border-red-200"; resultDiv.innerHTML = `<strong>Error:</strong> ${data.error || 'Upload failed.'}`; } } catch (e) { console.error(e); Toastify({ text: "Network error", style: { background: "#ef4444" } }).showToast(); } finally { btn.disabled = false; btn.innerHTML = '<i class="fa-solid fa-upload mr-2"></i> Upload & Create'; } }
        function downloadReport() { const element = document.getElementById('report-section'); Toastify({ text: "Generating report...", style: { background: "#3b82f6" } }).showToast(); html2canvas(element, { scale: 2 }).then(canvas => { const link = document.createElement('a'); link.download = `Gunaso_Report_${new Date().toISOString().split('T')[0]}.png`; link.href = canvas.toDataURL(); link.click(); Toastify({ text: "Report downloaded!", style: { background: "#10b981" } }).showToast(); }).catch(err => { Toastify({ text: "Failed to generate report", style: { background: "#ef4444" } }).showToast(); }); }
        async function loadProfile() { try { const res = await fetch(`${API_URL}/profile/`, { headers: { 'Authorization': `Bearer ${token}` } }); if (!res.ok) throw new Error(); const profile = await res.json(); if (profile.role === 'CITIZEN') { window.location.href = 'index.html'; return; } currentRole = profile.role; document.getElementById('welcome-msg').textContent = `Welcome, ${profile.first_name || profile.username}`; const badge = document.getElementById('ministry-badge'); badge.classList.remove('hidden'); if (currentRole === 'SUPER' || (profile.user && profile.user.is_superuser)) { badge.textContent = "PMO / Super Admin"; badge.className = "ml-4 px-3 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800 border border-purple-200"; document.getElementById('pmo-controls').classList.remove('hidden'); document.getElementById('btn-bulk-create').classList.remove('hidden'); document.getElementById('btn-bulk-create').classList.add('flex'); loadMinistriesList(); } else { badge.textContent = profile.ministry || "Ministry Admin"; } } catch (e) { window.location.href = 'login.html'; } }
        async function loadDashboardData() { await Promise.all([loadStats(), loadComplaints()]); }
        async function loadStats() { try { const res = await fetch(`${API_URL}/complaints/stats/`, { headers: { 'Authorization': `Bearer ${token}` } }); const stats = await res.json(); animateValue("stat-total", parseInt(document.getElementById("stat-total").innerText), stats.total, 1000); animateValue("stat-resolved", parseInt(document.getElementById("stat-resolved").innerText), stats.resolved, 1000); animateValue("stat-pending", parseInt(document.getElementById("stat-pending").innerText), stats.pending, 1000); const badge = document.getElementById('notification-badge'); if (stats.pending > 0) { badge.textContent = stats.pending > 99 ? '99+' : stats.pending; badge.classList.remove('opacity-0'); } else { badge.classList.add('opacity-0'); } renderChart(stats); } catch (e) {} }
        function renderChart(stats) { const ctx = document.getElementById('statusChart').getContext('2d'); if (statusChart) statusChart.destroy(); statusChart = new Chart(ctx, { type: 'doughnut', data: { labels: ['Pending', 'In Progress', 'Resolved', 'Rejected'], datasets: [{ data: [stats.pending, stats.in_progress, stats.resolved, stats.rejected], backgroundColor: ['#f97316', '#eab308', '#22c55e', '#ef4444'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, cutout: '70%' } }); }
        async function loadComplaints() { const tbody = document.getElementById('complaints-table-body'); try { const res = await fetch(`${API_URL}/complaints/`, { headers: { 'Authorization': `Bearer ${token}` } }); const data = await res.json(); let complaints = data.results || data; const ministryFilter = document.getElementById('ministry-filter')?.value; if (currentRole === 'SUPER' && ministryFilter) { complaints = complaints.filter(c => c.ministries.some(m => m.name === ministryFilter)); } complaintsData = complaints; renderTable(complaints); updateNotifications(complaints); } catch (e) { tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-red-500">Failed to load data.</td></tr>'; } }
        function renderTable(complaints) { const tbody = document.getElementById('complaints-table-body'); tbody.innerHTML = ''; if (!complaints.length) { tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-gray-400 font-medium">No grievances found.</td></tr>'; return; } complaints.forEach(c => { const pColor = c.ai_suggested_priority === 'HIGH' ? 'bg-red-100 text-red-700 border-red-200' : (c.ai_suggested_priority === 'MEDIUM' ? 'bg-yellow-100 text-yellow-700 border-yellow-200' : 'bg-gray-100 text-gray-600 border-gray-200'); let sColor = c.status === 'RESOLVED' ? 'bg-green-100 text-green-700' : (c.status === 'IN_PROGRESS' ? 'bg-yellow-50 text-yellow-700 border border-yellow-200' : (c.status === 'REJECTED' ? 'bg-red-50 text-red-700 border border-red-200' : 'bg-gray-100 text-gray-800')); let ministryNames = 'N/A'; if (c.ministries && c.ministries.length > 0) { ministryNames = c.ministries.map(m => m.name).join(', '); if(ministryNames.length > 50) ministryNames = ministryNames.substring(0, 50) + '...'; } tbody.innerHTML += `<tr class="hover:bg-gray-50 transition border-b border-gray-50 last:border-0"><td class="px-6 py-4 whitespace-nowrap text-xs font-mono text-gray-500">#${c.tracking_id.substring(0,6)}</td><td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 truncate max-w-[200px]">${c.title}</td><td class="px-6 py-4 whitespace-nowrap text-xs text-gray-600 truncate max-w-[200px]" title="${ministryNames}"><i class="fa-solid fa-building-columns text-gray-400 mr-1"></i> ${ministryNames}</td><td class="px-6 py-4 whitespace-nowrap"><span class="px-2 py-0.5 rounded border text-[10px] font-bold uppercase tracking-wide ${pColor}">${c.ai_suggested_priority || 'LOW'}</span></td><td class="px-6 py-4 whitespace-nowrap"><span class="px-2.5 py-1 rounded-full text-xs font-semibold ${sColor}">${c.status.replace('_', ' ')}</span></td><td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2"><button onclick="openDetailsModal('${c.tracking_id}')" class="text-gray-500 hover:text-blue-600 transition bg-white border border-gray-200 hover:border-blue-300 p-1.5 rounded-md shadow-sm"><i class="fa-regular fa-eye"></i></button><button onclick="openStatusModal('${c.tracking_id}', '${c.status}')" class="text-gray-500 hover:text-green-600 transition bg-white border border-gray-200 hover:border-green-300 p-1.5 rounded-md shadow-sm"><i class="fa-solid fa-pen"></i></button></td></tr>`; }); }
        function updateNotifications(complaints) { const pending = complaints.filter(c => c.status === 'PENDING'); const list = document.getElementById('notification-list'); const seenIds = JSON.parse(localStorage.getItem('seen_complaints') || '[]'); const unseenCount = pending.filter(c => !seenIds.includes(c.tracking_id)).length; list.innerHTML = ''; if (pending.length === 0) list.innerHTML = '<div class="p-8 text-center text-gray-400 text-sm">No new notifications</div>'; else pending.forEach(c => { const isUnread = !seenIds.includes(c.tracking_id); list.innerHTML += `<div class="${isUnread?'bg-blue-50':'bg-white'} p-4 border-b border-gray-50 hover:bg-gray-50 cursor-pointer flex items-center" onclick="openDetailsModal('${c.tracking_id}')">${isUnread?'<div class="h-2 w-2 bg-blue-500 rounded-full mr-3"></div>':''}<div class="flex-1"><p class="text-sm font-semibold text-gray-800 truncate">${c.title}</p><p class="text-xs text-gray-500 mt-0.5">ID: ${c.tracking_id.substring(0,8)}... â€¢ ${new Date(c.created_at).toLocaleDateString()}</p></div></div>`; }); }
        function toggleNotifications() { document.getElementById('notification-dropdown').classList.toggle('hidden'); }
        function markAllAsRead() { const pendingIds = complaintsData.filter(c => c.status === 'PENDING').map(c => c.tracking_id); localStorage.setItem('seen_complaints', JSON.stringify(pendingIds)); updateNotifications(complaintsData); Toastify({ text: "All marked as read", style: { background: "#6b7280" }, duration: 2000 }).showToast(); }
        function animateValue(id, start, end, duration) { if (start === end) return; const range = end - start; const obj = document.getElementById(id); let startTime = null; function step(timestamp) { if (!startTime) startTime = timestamp; const progress = Math.min((timestamp - startTime) / duration, 1); obj.innerHTML = Math.floor(progress * range + start); if (progress < 1) window.requestAnimationFrame(step); } window.requestAnimationFrame(step); }
        async function loadMinistriesList() { try { const res = await fetch(`${API_URL}/ministries/`); const data = await res.json(); const sel = document.getElementById('ministry-filter'); (data.results || data).forEach(m => sel.innerHTML += `<option value="${m.name}">${m.name}</option>`); } catch(e){} }
        function handleLogout() { localStorage.clear(); window.location.href = 'login.html'; }
    </script>
</body>
</html>